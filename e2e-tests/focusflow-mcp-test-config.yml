# FocusFlow MCP 自動化測試配置
# 完整的端到端測試流程，包含自動截圖和錯誤捕捉機制
# 
# 版本: 3.0
# 作者: FocusFlow Team
# 更新日期: 2025-07-29

name: "FocusFlow MCP 完整測試套件"
version: "3.0"
description: "涵蓋所有核心功能的自動化測試，包含智能生成、專注計時器、統計報表等"

# 測試環境配置
environment:
  baseUrl: "http://localhost:8081"
  backendUrl: "http://localhost:3001"
  timeout: 30000
  retries: 3
  screenshotPath: "./test-results/screenshots"
  videoPath: "./test-results/videos"
  reportPath: "./test-results/reports"

# 瀏覽器配置
browsers:
  - name: "chromium"
    enabled: true
    headless: false  # 設為 false 以便觀察測試過程
    viewport:
      width: 1280
      height: 720
    recordVideo: true
    trace: true

# 測試數據
testData:
  validTask:
    title: "學習 React Native 開發"
    description: "完整學習 React Native 移動應用開發，包括組件開發、狀態管理、導航等核心概念"
    dueDate: "2025-08-15"
    difficulty: "medium"
    priority: "high"
  
  complexTask:
    title: "建立完整的 AI 對話系統"
    description: "使用 Python 和機器學習技術建立智能對話系統，包含自然語言處理、意圖識別、對話管理和響應生成"
    dueDate: "2025-09-30"
    difficulty: "hard"
    priority: "high"

# 測試流程定義
testSuites:
  
  # 🚀 測試套件 1: 動態個人化問題生成測試 (Phase 2 優化驗證)
  - name: "dynamic-personalization-system"
    description: "驗證動態個人化問題生成系統 (1-8 問題自適應生成)"
    priority: "critical"
    
    tests:
      - name: "01-simple-task-personalization"
        description: "簡單任務個人化問題生成測試 (預期 1-3 問題)"
        steps:
          - action: "navigate"
            target: "{{ environment.baseUrl }}/add-task"
            screenshot:
              name: "simple-task-start"
              
          - action: "fill"
            selector: "[data-testid='task-title-input']"
            value: "學習基礎英文單字"
            
          - action: "fill"
            selector: "[data-testid='task-description-input']"
            value: "每天背誦10個新單字"
            screenshot:
              name: "simple-task-filled"
              
          - action: "click"
            selector: "[data-testid='smart-generate-button']"
            
          - action: "waitForSelector"
            selector: "[data-testid='personalization-modal']"
            timeout: 15000
            screenshot:
              name: "simple-task-personalization-modal"
              
          - action: "verify"
            type: "elementCount"
            selector: "[data-testid='question-item']"
            expectedCount: { min: 1, max: 3 }
            errorMessage: "簡單任務個人化問題數量不在預期範圍 (1-3 個)"
            screenshot:
              name: "simple-task-question-count"
              onError: true
              
          - action: "verifyTransparency"
            checks:
              - hasQuestionRationale: true
              - hasComplexityExplanation: true
              - hasSufficiencyScore: true
            screenshot:
              name: "simple-task-transparency"
              onError: true

      - name: "02-complex-task-personalization" 
        description: "複雜任務個人化問題生成測試 (預期 6-8 問題)"
        steps:
          - action: "navigate"
            target: "{{ environment.baseUrl }}/add-task"
            screenshot:
              name: "complex-task-start"
              
          - action: "fill"
            selector: "[data-testid='task-title-input']"
            value: "{{ testData.complexTask.title }}"
            
          - action: "fill" 
            selector: "[data-testid='task-description-input']"
            value: "{{ testData.complexTask.description }}"
            screenshot:
              name: "complex-task-filled"
              
          - action: "click"
            selector: "[data-testid='smart-generate-button']"
            
          - action: "waitForSelector"
            selector: "[data-testid='personalization-modal']"
            timeout: 15000
            screenshot:
              name: "complex-task-personalization-modal"
              
          - action: "verify"
            type: "elementCount"
            selector: "[data-testid='question-item']"
            expectedCount: { min: 6, max: 8 }
            errorMessage: "複雜任務個人化問題數量不在預期範圍 (6-8 個)"
            screenshot:
              name: "complex-task-question-count"
              onError: true
              
          - action: "verifyQuestionQuality"
            checks:
              - hasDiagnosticQuestions: true
              - hasSkillAssessment: true  
              - hasTimeConstraintQuestions: true
              - hasPreferenceQuestions: true
            screenshot:
              name: "complex-task-question-quality"
              onError: true

      - name: "03-medium-task-personalization"
        description: "中等任務個人化問題生成測試 (預期 3-5 問題)"
        steps:
          - action: "navigate"
            target: "{{ environment.baseUrl }}/add-task"
            screenshot:
              name: "medium-task-start"
              
          - action: "fill"
            selector: "[data-testid='task-title-input']"
            value: "{{ testData.validTask.title }}"
            
          - action: "fill"
            selector: "[data-testid='task-description-input']"
            value: "{{ testData.validTask.description }}"
            screenshot:
              name: "medium-task-filled"
              
          - action: "click"
            selector: "[data-testid='smart-generate-button']"
            
          - action: "waitForSelector"
            selector: "[data-testid='personalization-modal']"
            timeout: 15000
            screenshot:
              name: "medium-task-personalization-modal"
              
          - action: "verify"
            type: "elementCount"
            selector: "[data-testid='question-item']"
            expectedCount: { min: 3, max: 5 }
            errorMessage: "中等任務個人化問題數量不在預期範圍 (3-5 個)"
            screenshot:
              name: "medium-task-question-count"
              onError: true

  # 🚀 測試套件 2: 分段式生成性能優化測試 (Phase 4 優化驗證)
  - name: "segmented-generation-performance"
    description: "驗證分段式生成系統性能優化 (框架→展開→個人化)"
    priority: "high"
    
    tests:
      - name: "01-segmented-generation-progress"
        description: "分段式生成進度追蹤測試"
        steps:
          - action: "navigate"
            target: "{{ environment.baseUrl }}/add-task"
            
          - action: "fill"
            selector: "[data-testid='task-title-input']"
            value: "{{ testData.complexTask.title }}"
            
          - action: "fill"
            selector: "[data-testid='task-description-input']"
            value: "{{ testData.complexTask.description }}"
            
          - action: "fillQuestions"  
            answers:
              experience: "beginner"
              timeAvailable: "1-2 hours daily"
              learningStyle: "structured learning"
            screenshot:
              name: "complex-personalization-completed"
              
          - action: "click"
            selector: "[data-testid='complete-personalization-button']"
            
          - action: "waitForSelector"
            selector: "[data-testid='generation-progress-modal']"
            timeout: 5000
            screenshot:
              name: "progress-modal-appeared"
              
          - action: "verifyProgressStages"
            expectedStages:
              - name: "framework"
                message: "正在生成學習框架"
                expectedProgress: { min: 10, max: 30 }
              - name: "details"
                message: "正在展開"
                expectedProgress: { min: 30, max: 70 }
              - name: "personalization"
                message: "應用個人化調整"
                expectedProgress: { min: 80, max: 95 }
              - name: "complete"
                message: "子任務生成完成"
                expectedProgress: 100
            screenshot:
              name: "progress-stages-verified"
              onError: true
              
          - action: "measurePerformance"
            metric: "totalGenerationTime"
            expectedMax: 25000  # 25秒內完成 (比原來40-60秒快)
            screenshot:
              name: "performance-measurement"
              onError: true

      - name: "02-performance-monitoring-integration"
        description: "性能監控儀表板整合測試"
        steps:
          - action: "navigate"
            target: "{{ environment.baseUrl }}/profile"
            
          - action: "scrollToElement"
            selector: "[data-testid='performance-monitor-button']"
            
          - action: "click"
            selector: "[data-testid='performance-monitor-button']"
            screenshot:
              name: "performance-monitor-opened"
              
          - action: "waitForSelector"
            selector: "[data-testid='performance-metrics-container']"
            timeout: 5000
            
          - action: "verifyPerformanceMetrics"
            expectedMetrics:
              - name: "AI 響應時間"
                unit: "ms"
                expectedMax: 2000
              - name: "子任務生成速度"
                unit: "tasks/min"
                expectedMin: 6.0
              - name: "用戶流程完成率"
                unit: "%"
                expectedMin: 80
              - name: "錯誤發生率"
                unit: "%"
                expectedMax: 5
            screenshot:
              name: "performance-metrics-verified"
              onError: true
              
          - action: "click"
            selector: "[data-testid='refresh-metrics-button']"
            
          - action: "waitForUpdate"
            selector: "[data-testid='performance-metrics-container']"
            timeout: 3000
            screenshot:
              name: "metrics-refreshed"

  # 🚀 測試套件 3: 排程同步系統測試 (Phase 3 優化驗證)
  - name: "scheduling-synchronization"
    description: "驗證任務排程與 scheduledTasks 狀態同步"
    priority: "high"
    
    tests:
      - name: "01-task-scheduling-flow"
        description: "完整任務排程流程測試"
        steps:
          - action: "createTaskWithScheduling"
            taskData:
              title: "測試排程任務"
              description: "用於驗證排程同步功能"
              enableScheduling: true
            screenshot:
              name: "task-with-scheduling-created"
              
          - action: "navigate"
            target: "{{ environment.baseUrl }}/tasks"
            
          - action: "waitForSelector"
            selector: "[data-testid='scheduled-tasks-section']"
            timeout: 5000
            
          - action: "verify"
            type: "elementVisible"
            selector: "[data-testid='scheduled-task-item']"
            errorMessage: "排程任務未在任務列表中顯示"
            screenshot:
              name: "scheduled-task-visible"
              onError: true
              
          - action: "verifyScheduleSync"
            checks:
              - taskStoreHasTask: true
              - scheduledTasksHasEntry: true
              - idsMatch: true
              - timeSlotsMatch: true
            screenshot:
              name: "schedule-sync-verified"
              onError: true

      - name: "02-subtask-scheduling-sync"
        description: "子任務排程同步測試"
        steps:
          - action: "createComplexTask"
            withSubtasks: true
            enableScheduling: true
            
          - action: "navigate"
            target: "{{ environment.baseUrl }}/tasks"
            
          - action: "expandTask"
            selector: "[data-testid='complex-task-item']"
            
          - action: "verifySubtaskSchedules"
            checks:
              - hasScheduledSubtasks: true
              - subtaskIdsCorrect: true
              - parentTaskIdCorrect: true
              - timeSlotAssignments: true
            screenshot:
              name: "subtask-schedules-verified"
              onError: true
              
          - action: "markSubtaskComplete"
            subtaskIndex: 0
            
          - action: "verifyScheduleCleanup"
            checks:
              - completedSubtaskScheduleRemoved: true
              - remainingSchedulesIntact: true
            screenshot:
              name: "schedule-cleanup-verified"
              onError: true

  # 測試套件 4: 核心功能流程測試
  - name: "complete-user-journey"
    description: "完整的用戶使用流程測試"
    priority: "critical"
    
    tests:
      - name: "01-application-startup"
        description: "應用程式啟動和初始化測試"
        steps:
          - action: "navigate"
            target: "{{ environment.baseUrl }}"
            timeout: 10000
            screenshot:
              name: "app-startup"
              description: "應用程式首次載入畫面"
          
          - action: "waitForSelector"
            selector: "[data-testid='main-container']"
            timeout: 5000
            
          - action: "verify"
            type: "elementVisible"
            selector: "[data-testid='add-task-button']"
            errorMessage: "主要任務按钮未顯示"
            screenshot:
              name: "main-interface-loaded"
              onError: true

      - name: "02-task-creation-flow"
        description: "任務創建完整流程測試"
        steps:
          - action: "click"
            selector: "[data-testid='add-task-button']"
            screenshot:
              name: "task-creation-start"
              description: "點擊創建任務按鈕"
          
          - action: "waitForSelector"
            selector: "[data-testid='task-form']"
            timeout: 3000
            
          - action: "fill"
            selector: "[data-testid='task-title-input']"
            value: "{{ testData.validTask.title }}"
            
          - action: "fill"
            selector: "[data-testid='task-description-input']"
            value: "{{ testData.validTask.description }}"
            screenshot:
              name: "task-form-filled"
              description: "任務表單填寫完成"
          
          - action: "click"
            selector: "[data-testid='smart-generate-button']"
            screenshot:
              name: "smart-generate-clicked"
              description: "點擊智能生成按鈕"
          
          - action: "waitForResponse"
            urlPattern: "**/api/ai/**"
            timeout: 30000
            errorHandling:
              onTimeout:
                screenshot:
                  name: "ai-request-timeout"
                  description: "AI 請求超時"
                action: "halt"
                
          - action: "waitForSelector"
            selector: "[data-testid='personalization-modal']"
            timeout: 10000
            screenshot:
              name: "personalization-modal-appeared"
              description: "個人化問題彈窗出現"

      - name: "03-personalization-questions"
        description: "個人化問題回答流程"
        steps:
          - action: "verify"
            type: "elementCount"
            selector: "[data-testid='question-item']"
            expectedCount: { min: 3, max: 8 }
            errorMessage: "個人化問題數量不在預期範圍內"
            
          - action: "fillQuestions"
            strategy: "comprehensive"  # 完整回答所有問題
            answers:
              experience: "intermediate"
              timeAvailable: "2-3 hours daily"
              learningStyle: "hands-on practice"
              goal: "build production applications"
            screenshot:
              name: "questions-answered"
              description: "個人化問題回答完成"
              
          - action: "click"
            selector: "[data-testid='complete-personalization-button']"
            screenshot:
              name: "personalization-submitted"
              description: "提交個人化問題"

      - name: "04-subtask-generation-verification"
        description: "子任務生成結果驗證"
        steps:
          - action: "waitForSelector"
            selector: "[data-testid='subtasks-container']"
            timeout: 45000  # AI 生成可能需要較長時間
            screenshot:
              name: "subtasks-generating"
              description: "等待子任務生成"
              
          - action: "verify"
            type: "elementCount"
            selector: "[data-testid='subtask-item']"
            expectedCount: { min: 5, max: 15 }
            errorMessage: "生成的子任務數量異常"
            screenshot:
              name: "subtasks-generated"
              description: "子任務生成完成"
              
          - action: "verifySubtaskQuality"
            checks:
              - hasTitle: true
              - hasDescription: true
              - hasDuration: true
              - hasDifficulty: true
              - hasOrder: true
            screenshot:
              name: "subtask-quality-check"
              onError: true
              
          - action: "click"
            selector: "[data-testid='save-task-button']"
            screenshot:
              name: "task-saved"
              description: "任務保存成功"

  # 測試套件 2: 專注計時器功能測試  
  - name: "focus-timer-functionality"
    description: "專注計時器核心功能測試"
    priority: "high"
    
    tests:
      - name: "01-timer-initialization"
        description: "計時器初始化測試"
        steps:
          - action: "navigate"
            target: "{{ environment.baseUrl }}/focus"
            screenshot:
              name: "focus-page-loaded"
              
          - action: "verify"
            type: "elementVisible"
            selector: "[data-testid='timer-display']"
            
          - action: "verify"
            type: "textContent"
            selector: "[data-testid='timer-display']"
            expectedText: "25:00"
            errorMessage: "計時器初始時間不正確"

      - name: "02-timer-start-and-pause"
        description: "計時器啟動和暫停測試"
        steps:
          - action: "click"
            selector: "[data-testid='start-timer-button']"
            screenshot:
              name: "timer-started"
              
          - action: "wait"
            duration: 3000  # 等待3秒觀察計時器運行
            
          - action: "verify"
            type: "textContent"
            selector: "[data-testid='timer-display']"
            expectedText: "24:57"
            tolerance: 2000  # 允許2秒誤差
            screenshot:
              name: "timer-counting-down"
              
          - action: "click"
            selector: "[data-testid='pause-timer-button']"
            screenshot:
              name: "timer-paused"
              
          - action: "wait"
            duration: 2000
            
          - action: "verifyTimerPaused"
            screenshot:
              name: "timer-pause-verified"
              onError: true

  # 測試套件 3: 統計報表功能測試
  - name: "statistics-and-analytics"
    description: "統計報表和分析功能測試"
    priority: "medium"
    
    tests:
      - name: "01-stats-page-navigation"
        description: "統計頁面導航測試"
        steps:
          - action: "navigate"
            target: "{{ environment.baseUrl }}/stats"
            screenshot:
              name: "stats-page-loaded"
              
          - action: "waitForSelector"
            selector: "[data-testid='stats-container']"
            
          - action: "verify"
            type: "elementVisible"
            selector: "[data-testid='productivity-chart']"
            screenshot:
              name: "productivity-chart-visible"

      - name: "02-data-visualization"
        description: "數據視覺化測試"
        steps:
          - action: "verifyChartData"
            chartSelector: "[data-testid='productivity-chart']"
            expectedDataPoints: { min: 1 }
            screenshot:
              name: "chart-data-verified"
              
          - action: "interactWithChart"
            chartSelector: "[data-testid='productivity-chart']"
            interaction: "hover"
            screenshot:
              name: "chart-interaction"

  # 測試套件 4: 錯誤處理和邊界情況測試
  - name: "error-handling-and-edge-cases"
    description: "錯誤處理和邊界情況測試"
    priority: "high"
    
    tests:
      - name: "01-invalid-input-handling"
        description: "無效輸入處理測試"
        steps:
          - action: "navigate"
            target: "{{ environment.baseUrl }}/add-task"
            
          - action: "fill"
            selector: "[data-testid='task-title-input']"
            value: ""  # 空標題
            
          - action: "click"
            selector: "[data-testid='smart-generate-button']"
            
          - action: "verify"
            type: "elementVisible"
            selector: "[data-testid='error-message']"
            screenshot:
              name: "empty-title-error"
              
          - action: "fill"
            selector: "[data-testid='task-title-input']"
            value: "a"  # 過短標題
            
          - action: "click"
            selector: "[data-testid='smart-generate-button']"
            
          - action: "verify"
            type: "elementVisible"
            selector: "[data-testid='quality-alert']"
            screenshot:
              name: "quality-alert-shown"

      - name: "02-network-error-simulation"
        description: "網路錯誤模擬測試"
        steps:
          - action: "interceptNetworkRequests"
            pattern: "**/api/ai/**"
            response:
              status: 500
              body: { error: "Internal Server Error" }
              
          - action: "fill"
            selector: "[data-testid='task-title-input']"
            value: "{{ testData.validTask.title }}"
            
          - action: "click"
            selector: "[data-testid='smart-generate-button']"
            
          - action: "waitForSelector"
            selector: "[data-testid='error-dialog']"
            timeout: 10000
            screenshot:
              name: "network-error-dialog"
              
          - action: "verify"
            type: "textContent"
            selector: "[data-testid='error-message']"
            contains: "network"
            screenshot:
              name: "network-error-message"

# 全域錯誤處理配置
errorHandling:
  
  # 自動截圖設定
  autoScreenshot:
    enabled: true
    onError: true
    onTimeout: true
    onAssertion: true
    quality: 90
    fullPage: true
    
  # 錯誤恢復策略
  recovery:
    enabled: true
    strategies:
      - type: "refresh"
        condition: "navigation_timeout"
        maxAttempts: 2
        
      - type: "restart"
        condition: "critical_error"
        maxAttempts: 1
        
      - type: "skip"
        condition: "non_critical_error"
        
  # 日誌配置
  logging:
    level: "detailed"
    includeScreenshots: true
    includeNetworkLogs: true
    includeConsoleErrors: true
    
  # 通知設定
  notifications:
    onCriticalError: true
    onTestComplete: true
    channels:
      - type: "console"
      - type: "file"
        path: "./test-results/error-log.json"

# 報告生成配置
reporting:
  formats:
    - "html"
    - "json"
    - "junit"
    
  html:
    title: "FocusFlow MCP 測試報告"
    includeScreenshots: true
    includeVideos: true
    theme: "dark"
    
  customMetrics:
    - name: "AI 響應時間"
      description: "AI API 平均響應時間"
      unit: "ms"
      threshold: 2000
      
    - name: "任務生成成功率"
      description: "智能任務生成成功率"
      unit: "%"
      threshold: 90
      
    - name: "用戶流程完成時間"
      description: "完整用戶流程平均完成時間"
      unit: "seconds"
      threshold: 30
      
    # 🚀 Phase 優化新增指標
    - name: "動態問題生成準確度"
      description: "個人化問題數量是否符合任務複雜度預期"
      unit: "%"
      threshold: 85
      
    - name: "分段式生成性能改善"
      description: "相比單次生成的性能提升百分比"
      unit: "%"
      threshold: 30
      
    - name: "排程同步一致性"
      description: "taskStore 和 scheduledTasks 狀態同步準確率"
      unit: "%"
      threshold: 95
      
    - name: "透明度功能可見性"
      description: "AI 決策透明度元素的可見率"
      unit: "%"
      threshold: 90
      
    - name: "子任務指引完整性"
      description: "子任務包含行動指引的完整率"
      unit: "%"
      threshold: 80

# 性能監控配置
performance:
  enabled: true
  metrics:
    - "firstContentfulPaint"
    - "largestContentfulPaint"
    - "timeToInteractive"
    - "totalBlockingTime"
    
  thresholds:
    firstContentfulPaint: 2000  # 2秒內
    largestContentfulPaint: 4000  # 4秒內
    timeToInteractive: 5000  # 5秒內
    
  screenshot:
    onThresholdExceeded: true
    
# 清理配置
cleanup:
  afterEach: true
  afterSuite: true
  actions:
    - "clearLocalStorage"
    - "clearSessionStorage"
    - "clearCookies"
    - "resetDatabase"  # 如果有測試數據庫

# 並行執行配置
parallel:
  enabled: true
  workers: 2
  strategy: "suite"  # 按測試套件並行
  
# 重試配置
retry:
  enabled: true
  maxAttempts: 2
  conditions:
    - "timeout"
    - "network_error"
    - "element_not_found"