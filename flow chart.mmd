flowchart TD

%% =======================================================
%% 0. å…¨å±€æ¨£å¼å®šç¾© (System Architecture Design System)
%% =======================================================
classDef default font-family:'Arial',font-size:14px;
%% æ³³é“æ¨™é¡Œ (Lane Headers)
classDef laneTitle fill:#37474F,stroke:#263238,stroke-width:0px,color:#FFFFFF,font-size:16px,font-weight:bold;

%% ç¯€é»æ¨£å¼ (Node Styles)
%% User: æš–è‰²ç³»ï¼Œä»£è¡¨äººé¡æ„åœ–
classDef userStep fill:#FFF3E0,stroke:#EF6C00,stroke-width:2px,color:#E65100,rx:5,ry:5;

%% UI: å†·è‰²ç³»ï¼Œä»£è¡¨å‰ç«¯ä»‹é¢
classDef uiStep fill:#E3F2FD,stroke:#1565C0,stroke-width:2px,color:#0D47A1,rx:5,ry:5;

%% Backend: ç¶ è‰²ç³»ï¼Œä»£è¡¨é‚è¼¯é‹ç®—
classDef beStep fill:#E8F5E9,stroke:#2E7D32,stroke-width:2px,color:#1B5E20,rx:2,ry:2;

%% Database: æ·±ç°è‰²ï¼Œåœ“æŸ±é«”
classDef dbNode fill:#CFD8DC,stroke:#455A64,stroke-width:3px,color:#263238,shape:cylinder;

%% Decision: é»ƒè‰²ç³»ï¼Œè±å½¢
classDef decision fill:#FFFDE7,stroke:#FBC02D,stroke-width:2px,color:#F57F17,shape:diamond;

%% Start/End
classDef terminator fill:#212121,stroke:#000000,color:#fff,rx:10,ry:10;


%% =======================================================
%% æµç¨‹ä¸€ï¼šå»ºç«‹æ–°å­¸ç¿’è¨ˆç•« (Smart Diagnosis Flow)
%% =======================================================
subgraph FLOW1 ["ğŸ“˜ <b>Scenario 1: å»ºç«‹æ–°å­¸ç¿’è¨ˆç•« (Smart Diagnosis & Scheduling)</b>"]
    direction TB
    
    subgraph U_Lane1 ["ğŸ‘¤ ä½¿ç”¨è€…æ—…ç¨‹"]
        direction TB
        U1("U1: æƒ³è¦ç³»çµ±åŒ–å­¸ç¿’<br/>æˆ–æº–å‚™è€ƒè©¦")
        U2("U2: æ±ºå®šå»ºç«‹æ–°ä»»å‹™")
        U3("U3: é–±è®€ AI è¨ºæ–·çµæœ<br/>èˆ‡å­¸ç¿’è¨ˆç•«")
        U4{"U4: æ¥å—è¨ˆç•«ï¼Ÿ"}
        U5("U5: å¾®èª¿è¨ˆç•«<br/>(åˆªæ”¹/èª¿æ•´æ™‚é–“)")
        U6("U6: ç¢ºèªé–‹å§‹")
    end

    subgraph UI_Lane1 ["ğŸ“± å‰ç«¯ UI (App)"]
        direction TB
        F1("F1: Home<br/>æŒ‰ã€ï¼‹ å»ºç«‹å­¸ç¿’ä»»å‹™ã€")
        F2("F2: Step1 è¼¸å…¥<br/>æ¨™é¡Œ / é¡å‹ / æˆªæ­¢æ—¥")
        F3("F3: æŒ‰ã€ä¸‹ä¸€æ­¥ã€<br/>å•Ÿå‹• AI å•ç­”")
        F4("F4: Step2 é¡¯ç¤º<br/>è¨ºæ–·å•é¡Œ Q(n)")
        F5("F5: å¡«ç­”ä¸¦é€å‡º")
        F6("F6: æ›´æ–°ç•«é¢<br/>ä¸‹ä¸€é¡Œ or å®Œæˆ")
        F7("F7: Step3 é¡¯ç¤ºæ‘˜è¦<br/>é›£åº¦ / ç¸½æ™‚æ•¸")
        F8("F8: è¨­å®šåå¥½<br/>å„ªå…ˆç´š / Auto-Schedule")
        F9("F9: æŒ‰ã€âš¡ ç”Ÿæˆè¨ˆç•«ã€")
        F10("F10: Task Detail<br/>Modules / Subtasks / é€²åº¦")
    end
    subgraph BE_Lane1 ["ğŸ”§ å¾Œç«¯ (Intelligence Engine)"]
        direction TB
        subgraph BE_Diag ["ğŸ§  Smart Diagnosis"]
            B1[["B1: POST /tasks/diagnosis<br/>æ¥æ”¶è¼¸å…¥ & å›ç­”"]]
            B2[["B2: åˆ†æè³‡è¨Šç¼ºå£<br/>(Goal & Background)"]]
            B3{"B3: è³‡è¨Š<br/>è¶³å¤ ï¼Ÿ"}
            B4[["B4: ç”Ÿæˆä¸‹ä¸€é¡Œ<br/>(Question + Type)"]]
            B5[["B5: è¨ˆç®—æœ€çµ‚çµæœ<br/>é›£åº¦ / æ·±åº¦ / æ™‚æ•¸"]]
        end

        subgraph BE_Plan ["âš™ï¸ Plan Generation"]
            B6[["B6: StudyPlan æ¨¡çµ„<br/>æ‹†è§£ Modules / Milestones"]]
            B7[["B7: Subtask Generator<br/>ç”¢ç”Ÿè©³ç´°å­ä»»å‹™å±¬æ€§"]]
        end

        subgraph BE_Sched ["ğŸ“… Storage & Scheduling"]
            B8[["B8: å¯«å…¥ TaskDB"]]
            B9{"B9: é–‹å•Ÿ<br/>Auto-Sched?"}
            B10[["B10: è®€å– UserProfile<br/>(å¯ç”¨æ™‚é–“)"]]
            B11[["B11: è®€å– ScheduleDB<br/>(è¡çªæª¢æ¸¬)"]]
            B12[["B12: åˆ†é… CalendarBlocks"]]
            B13[["B13: Call Calendar Sync API"]]
            B14[["B14: å›å‚³å®Œæ•´ Payload<br/>(Task + Schedule)"]]
        end
    end

    %% é€£ç·šé‚è¼¯
    U1 --> U2 --> F1 --> F2 --> F3
    F3 --> B1 --> B2 --> B3
    B3 -->|No: è¿½å•| B4 --> F4 --> F5 --> B1
    B3 -->|Yes: å®Œæˆ| B5 --> F7
    F5 --> F6 --> F4
    F7 --> F8 --> F9 --> B6 --> B7 --> B8
    
    B8 --> B9
    B9 -->|No| B14
    B9 -->|Yes| B10 --> B11 --> B12 --> B14
    B12 --> B13
    
    B14 --> F10 --> U3
    U3 --> U4
    U4 -->|No| U5 --> F10
    U4 -->|Yes| U6 --> F10
end


%% =======================================================
%% æµç¨‹äºŒï¼šåŸ·è¡Œå­ä»»å‹™ (Execution Flow)
%% =======================================================
subgraph FLOW2 ["â–¶ï¸ <b>Scenario 2: åŸ·è¡Œèˆ‡å°ˆæ³¨ (Execution & Tracking)</b>"]
    direction TB

    subgraph U_Lane2 ["ğŸ‘¤ ä½¿ç”¨è€…"]
        U2_1("U1: æƒ³é–‹å§‹å­¸ç¿’")
        U2_2("U2: é¸æ“‡å­ä»»å‹™")
        U2_3("U3: é€²å…¥å°ˆæ³¨ç‹€æ…‹")
        U2_4("U4: å°ˆæ³¨å›é¡§<br/>(å®Œæˆåº¦/é›£åº¦)")
        U2_5{"U5: ç¹¼çºŒ<br/>ä¸‹ä¸€å€‹ï¼Ÿ"}
        U2_6("U6: ä¼‘æ¯/çµæŸ")
    end

    subgraph UI_Lane2 ["ğŸ“± å‰ç«¯ UI"]
        F2_1("F1: Home æ¨è–¦<br/>ã€ä¸‹ä¸€æ­¥å»ºè­°ã€")
        F2_2("F2: Task Detail")
        F2_3("F3: é»é¸å­ä»»å‹™")
        F2_4("F4: æŒ‰ã€é–‹å§‹å°ˆæ³¨ã€")
        F2_5("F5: è¨ˆæ™‚å™¨é‹ä½œ<br/>(å€’æ•¸/æš«åœ)")
        F2_6("F6: åˆ†å¿ƒç›£æ§<br/>(Foreground Check)")
        F2_7{"F7: ç™½åå–®<br/>Appï¼Ÿ"}
        F2_8("F8: Block UI / æé†’")
        F2_9("F9: çµæŸç•«é¢")
        F2_10("F10: å›é¡§è¡¨å–®")
        F2_11("F11: æ›´æ–°é€²åº¦æ¢")
    end

    subgraph BE_Lane2 ["ğŸ”§ å¾Œç«¯ (Focus Engine)"]
        B2_1[["B1: POST /focus/start"]]
        B2_2[["B2: Create Session"]]
        B2_3[["B3: POST /focus/distraction"]]
        B2_4[["B4: Log Distraction"]]
        B2_5[["B5: POST /focus/end"]]
        B2_6[["B6: Update Session Status"]]
        B2_7[["B7: Update Subtask Progress"]]
        B2_8{"B8: å®Œå…¨<br/>å®Œæˆï¼Ÿ"}
        B2_9[["B9: è§¸ç™¼é‡æ’ç¨‹è¨Šè™Ÿ"]]
        B2_10[["B10: Reschedule Remaining"]]
    end

    %% é€£ç·šé‚è¼¯
    U2_1 --> F2_1 --> F2_2 --> F2_3 --> U2_2
    F2_3 --> F2_4 --> U2_3
    
    F2_4 --> B2_1 --> B2_2 --> F2_5
    
    F2_5 --> F2_6 --> F2_7
    F2_7 -->|Yes| F2_5
    F2_7 -->|No| F2_8 --> F2_5
    F2_6 -->|Alert| B2_3 --> B2_4
    
    F2_5 --> F2_9 --> F2_10 --> U2_4
    F2_10 --> B2_5 --> B2_6 --> B2_7 --> B2_8
    B2_8 -->|Partial| B2_9 --> B2_10
    B2_7 --> F2_11 --> U2_5
    
    U2_5 -->|Yes| F2_2
    U2_5 -->|No| U2_6
end

%% =======================================================
%% æµç¨‹ä¸‰ï¼šå›é¡§èˆ‡èª¿æ•´ (Review Flow)
%% =======================================================
subgraph FLOW3 ["ğŸ“ˆ <b>Scenario 3: å›é¡§èˆ‡ç­–ç•¥èª¿æ•´ (Review & Re-strategy)</b>"]
    direction TB
    subgraph U_Lane3 ["ğŸ‘¤ ä½¿ç”¨è€…"]
        U3_1("U1: æƒ³ç¢ºèªé€²æ­¥ç‹€æ³")
        U3_2("U2: æ‰“é–‹ Statistics")
        U3_3("U3: é–±è®€åœ–è¡¨èˆ‡å»ºè­°")
        U3_4{"U4: èª¿æ•´<br/>ç­–ç•¥ï¼Ÿ"}
        U3_5("U5: èª¿æ•´åå¥½è¨­å®š")
        U3_6("U6: å›åˆ° Home ç¹¼çºŒ")
    end

    subgraph UI_Lane3 ["ğŸ“± å‰ç«¯ UI"]
        F3_1("F1: Statistics é é¢")
        F3_2("F2: è«‹æ±‚ Stats & Tips")
        F3_3("F3: é¡¯ç¤ºå„€è¡¨æ¿<br/>(Streak/Completion)")
        F3_4("F4: Profile/Settings")
        F3_5("F5: ä¿®æ”¹åƒæ•¸<br/>(æ™‚é–“/è‡ªå‹•æ’ç¨‹)")
        F3_6("F6: å„²å­˜è¨­å®š")
    end

    subgraph BE_Lane3 ["ğŸ”§ å¾Œç«¯ (Analytics)"]
        B3_1[["B1: GET /stats/summary"]]
        B3_2[["B2: Aggregate Data<br/>(Sessions/Tasks)"]]
        B3_3[["B3: Calc Metrics"]]
        B3_4[["B4: Gen Natural Lang Summary"]]
        B3_5[["B5: Gen Productivity Tip"]]
        B3_6[["B6: Return Stats payload"]]
        
        B3_7[["B7: POST /user/settings"]]
        B3_8[["B8: Update Profile"]]
        B3_9{"B9: å½±éŸ¿<br/>æ’ç¨‹ï¼Ÿ"}
        B3_10[["B10: Fetch Pending Tasks"]]
        B3_11[["B11: Recalculate CalendarBlocks"]]
    end

    %% é€£ç·šé‚è¼¯
    U3_1 --> U3_2 --> F3_1 --> F3_2 --> B3_1
    B3_1 --> B3_2 --> B3_3 --> B3_4 --> B3_5 --> B3_6 --> F3_3 --> U3_3
    
    U3_3 --> U3_4
    U3_4 -->|No| U3_6
    U3_4 -->|Yes| U3_5 --> F3_4 --> F3_5 --> F3_6 --> B3_7
    
    B3_7 --> B3_8 --> B3_9
    B3_9 -->|No| F3_1
    B3_9 -->|Yes| B3_10 --> B3_11
    B3_11 --> U3_6
end

%% è³‡æ–™åº«ç¯€é» (Shared Data Layer)
subgraph DataLayer ["ğŸ“Š Shared Data Layer"]
    D1[("TaskDB")]
    D2[("UserDB")]
    D3[("ScheduleDB")]
    D4[("FocusDB")]
    D5[("CalendarAPI")]
end

%% é€£çµè³‡æ–™åº«
B8 & B2_7 & B3_10 & B3_2 --> D1
B10 & B3_8 & B2_2 --> D2
B11 & B12 & B3_11 & B2_10 --> D3
B2_2 & B2_4 & B2_6 & B3_2 --> D4
B13 --> D5

%% æ¨£å¼å¥—ç”¨
class U1,U2,U3,U4,U5,U6,U2_1,U2_2,U2_3,U2_4,U2_5,U2_6,U3_1,U3_2,U3_3,U3_4,U3_5,U3_6 userStep
class F1,F2,F3,F4,F5,F6,F7,F8,F9,F10,F2_1,F2_2,F2_3,F2_4,F2_5,F2_6,F2_7,F2_8,F2_9,F2_10,F2_11,F3_1,F3_2,F3_3,F3_4,F3_5,F3_6 uiStep
class B1,B2,B3,B4,B5,B6,B7,B8,B9,B10,B11,B12,B13,B14,B2_1,B2_2,B2_3,B2_4,B2_5,B2_6,B2_7,B2_8,B2_9,B2_10,B3_1,B3_2,B3_3,B3_4,B3_5,B3_6,B3_7,B3_8,B3_9,B3_10,B3_11 beStep
class D1,D2,D3,D4,D5 dbNode
class U4,B3,B9,U2_5,F2_7,B2_8,U3_4,B3_9 decision
class U_Lane1,UI_Lane1,BE_Lane1,BE_Diag,BE_Plan,BE_Sched,U_Lane2,UI_Lane2,BE_Lane2,U_Lane3,UI_Lane3,BE_Lane3 laneTitle
